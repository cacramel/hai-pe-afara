<script>
    let view = 'tasks';
    let tasks = JSON.parse(localStorage.getItem('alex_tasks')) || [];
    let notes = JSON.parse(localStorage.getItem('alex_notes')) || [];

    function setView(newView) {
        view = newView;
        document.getElementById('btn-tasks').classList.toggle('active', view === 'tasks');
        document.getElementById('btn-notes').classList.toggle('active', view === 'notes');
        document.getElementById('view-title').innerText = view === 'tasks' ? 'Task-uri' : 'Liste Simple';
        document.getElementById('progress-wrapper').classList.toggle('hidden', view === 'notes');
        render();
    }

    function saveData() {
        localStorage.setItem('alex_tasks', JSON.stringify(tasks));
        localStorage.setItem('alex_notes', JSON.stringify(notes));
    }

    function addItem() {
        const input = document.getElementById('user-input');
        if (!input.value.trim()) return;
        const item = { text: input.value, completed: false };
        if (view === 'tasks') tasks.push(item);
        else notes.push(item);
        input.value = '';
        saveData();
        render();
    }

    function render() {
        const listEl = document.getElementById('list');
        listEl.innerHTML = '';
        const data = (view === 'tasks') ? tasks : notes;

        data.forEach((item, index) => {
            const li = document.createElement('li');
            
            // Checkbox logic
            const check = view === 'tasks' ? 
                `<input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleItem(${index})">` : '';

            li.innerHTML = `
                ${check}
                <span class="item-text ${item.completed ? 'done-text' : ''}" 
                      id="text-${index}"
                      title="Dublu click pentru editare">
                    ${item.text}
                </span>
                <div class="delete-btn" onclick="deleteItem(${index})">✕</div>
            `;

            // Atașăm evenimentul de dublu click manual pentru siguranță
            const textSpan = li.querySelector(`#text-${index}`);
            textSpan.addEventListener('dblclick', function() {
                startEdit(this, index);
            });

            listEl.appendChild(li);
        });
        if (view === 'tasks') updateProgress();
    }

    // Funcția care declanșează editarea
    function startEdit(el, index) {
        el.contentEditable = "true";
        el.classList.add('editing'); // Putem adăuga un stil CSS dacă vrem
        el.focus();

        // Plasăm cursorul la finalul textului
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        // Salvare la pierderea focusului (click în altă parte)
        el.onblur = () => {
            finishEdit(el, index);
        };

        // Salvare la apăsarea tastei Enter
        el.onkeydown = (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                el.blur();
            }
        };
    }

    function finishEdit(el, index) {
        const newText = el.innerText.trim();
        const data = (view === 'tasks') ? tasks : notes;
        
        if (newText !== "") {
            data[index].text = newText;
            saveData();
        }
        
        el.contentEditable = "false";
        el.classList.remove('editing');
        render(); // Re-randăm pentru a curăța eventualele tag-uri HTML apărute accidental
    }

    function toggleItem(idx) {
        const data = (view === 'tasks') ? tasks : notes;
        data[idx].completed = !data[idx].completed;
        saveData();
        render();
    }

    function deleteItem(idx) {
        const data = (view === 'tasks') ? tasks : notes;
        data.splice(idx, 1);
        saveData();
        render();
    }

    function updateProgress() {
        const total = tasks.length;
        const done = tasks.filter(t => t.completed).length;
        const p = total === 0 ? 0 : Math.round((done / total) * 100);
        const bar = document.getElementById('bar-fill');
        if(bar) bar.style.width = p + '%';
        const text = document.getElementById('perc-text');
        if(text) text.innerText = p + '%';
    }

    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    }

    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
    });

    render();
</script>
